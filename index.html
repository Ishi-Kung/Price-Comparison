<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Comparison</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        h1 {
            color: #000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .main-container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: auto;
        }
        
        .button-container {
            margin: 20px 0;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .primary-btn {
            background-color: #2ecc71;
        }
        
        .primary-btn:hover {
            background-color: #27ae60;
        }
        
        .export-btn {
            background-color: #e67e22;
        }
        
        .export-btn:hover {
            background-color: #d35400;
        }
        
        .price-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .price-table th, .price-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .price-table th {
            position: sticky;
            top: 0;
            font-weight: bold;
        }
        
        .price-table tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        
        .price-table td:nth-child(2) {
            background-color: #f39c12;
            color: white;
        }
        
        .price-table th:nth-child(1), .price-table td:nth-child(1) {
            width: 50px;
            max-width: 50px;
        }
        
        .price-table th:nth-child(2), .price-table td:nth-child(2) {
            width: 120px;
            max-width: 120px;
        }
        
        .price-table th:nth-child(3), .price-table td:nth-child(3) {
            width: 250px;
            max-width: 250px;
            text-align: left;
        }
        
        .price-table th:nth-child(4), .price-table td:nth-child(4) {
            width: 150px;
            max-width: 150px;
            text-align: left;
        }
        
        .price-table th:nth-child(5), .price-table td:nth-child(5) {
            width: 120px;
            max-width: 120px;
        }
        
        .price-table td:nth-child(3) {
            color: #333;
        }
        
        .price-table th:nth-child(1) {
            background-color: #fff;
        }
        
        .price-table th:nth-child(2) {
            background-color: #f39c12;
            color: white;
        }
        
        .price-table th:nth-child(3) {
            background-color: #e74c3c;
            color: white;
        }
        
        .price-table th:nth-child(4) {
            background-color: #3498db;
            color: white;
        }
        
        .price-table th:nth-child(5) {
            background-color: #f1c40f;
            color: white;
        }
        
        /* Vendor column colors - we'll use a repeating pattern for many vendors */
        .price-table th.vendor-col {
            color: white;
        }
        
        .price-table th.vendor-col:nth-of-type(6n) {
            background-color: #2ecc71;
        }
        
        .price-table th.vendor-col:nth-of-type(6n+1) {
            background-color: #9b59b6;
        }
        
        .price-table th.vendor-col:nth-of-type(6n+2) {
            background-color: #95a5a6;
        }
        
        .price-table th.vendor-col:nth-of-type(6n+3) {
            background-color: #e67e22;
        }
        
        .price-table th.vendor-col:nth-of-type(6n+4) {
            background-color: #1abc9c;
        }
        
        .price-table th.vendor-col:nth-of-type(6n+5) {
            background-color: #34495e;
        }
        
        /* Highlighted text */
        .highlight-red {
            color: red;
            font-weight: bold;
        }
        
        .highlight-normal {
            font-weight: bold;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 5px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: #333;
            margin: 0;
            border-radius: 0;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: white;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .input-table th, .input-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .input-table th {
            background-color: #f2f2f2;
        }
        
        .input-table input[type="text"], 
        .input-table input[type="number"] {
            width: 95%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .vendor-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .vendor-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .vendor-item input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .vendor-item button {
            background-color: #e74c3c;
            padding: 5px 10px;
            margin: 0;
        }
        
        #imagePreview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
        }
        
        /* Dynamic vendor input fields in add row modal */
        #vendorInputs {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Responsive behavior */
        @media print {
            body {
                padding: 0;
                margin: 0;
            }
            
            .button-container, .add-row-btn, .export-section {
                display: none;
            }
            
            .main-container {
                box-shadow: none;
            }
            
            .price-table {
                font-size: 12px;
            }
        }
        
        @media (max-width: 768px) {
            .price-table {
                font-size: 12px;
            }
            
            .price-table th, .price-table td {
                padding: 5px;
            }
            
            .button-container button {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
            <h1>Price Comparison</h1>
            <div style="text-align: right; font-weight: bold; font-size: 18px;">Vendor</div>
        </div>
        
        <div class="table-container">
            <table id="priceTable" class="price-table">
                <thead>
                    <tr id="headerRow">
                        <th>No.</th>
                        <th>Image</th>
                        <th>Product</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <!-- Vendor columns will be added dynamically -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be added here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="button-container">
        <button id="addRowBtn" class="add-row-btn">Add Row</button>
        <button id="addAmountBtn">Add Amount Row</button>
        <button id="manageVendorsBtn">Manage Vendors</button>
        <button id="exportCSVBtn" class="export-btn">Export to CSV</button>
        <button id="saveDataBtn" class="primary-btn">Save Data</button>
        <button id="printBtn">Print Table</button>
    </div>
    
    <!-- Add Row Modal -->
    <div id="addRowModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAddRowModal">&times;</span>
            <h2>Add New Row</h2>
            
            <div style="margin-bottom: 20px;">
                <label for="productInput" style="font-weight: bold;">Product:</label><br>
                <textarea id="productInput" placeholder="e.g. Glass Jar - Plastic White/Black Lid&#10;Child's Lock Lid&#10;5.9cmx6.4cm to 6.2x6.7cm (Volcanee)&#10;5cmx6cm (Archibald)"></textarea>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <div style="flex: 1;">
                        <label for="descriptionInput" style="font-weight: bold;">Description:</label><br>
                        <input type="text" id="descriptionInput" style="width: 100%; padding: 8px;" placeholder="e.g. With Sticker">
                    </div>
                    <div>
                        <label for="imageInput" style="font-weight: bold;">Image (optional):</label><br>
                        <input type="file" id="imageInput" accept="image/*">
                        <div id="imagePreview"></div>
                    </div>
                </div>
            </div>
            
            <div>
                <label for="amountInput" style="font-weight: bold;">Amount:</label><br>
                <input type="text" id="amountInput" style="width: 200px; padding: 8px; margin-bottom: 15px;" placeholder="e.g. 5,000.00">
            </div>
            
            <div>
                <h3>Vendor Prices</h3>
                <div id="vendorInputs">
                    <!-- Vendor input fields will be added here dynamically -->
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button id="cancelAddRowBtn">Cancel</button>
                <button id="confirmAddRowBtn" class="primary-btn">Add Row</button>
            </div>
        </div>
    </div>
    
    <!-- Add Amount Row Modal -->
    <div id="addAmountModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAmountModal">&times;</span>
            <h2>Add Amount Row</h2>
            
            <p>Add a new amount (quantity) row to an existing product.</p>
            
            <div style="margin-bottom: 20px;">
                <label for="productSelect" style="font-weight: bold;">Select Product:</label><br>
                <select id="productSelect" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <!-- Products will be added here -->
                </select>
            </div>
            
            <div>
                <label for="newAmountInput" style="font-weight: bold;">Amount:</label><br>
                <input type="text" id="newAmountInput" style="width: 200px; padding: 8px; margin-bottom: 15px;" placeholder="e.g. 10,000.00">
            </div>
            
            <div>
                <h3>Vendor Prices</h3>
                <div id="newVendorInputs">
                    <!-- Vendor input fields will be added here dynamically -->
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button id="cancelAmountBtn">Cancel</button>
                <button id="confirmAmountBtn" class="primary-btn">Add Amount Row</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Vendors Modal -->
    <div id="manageVendorsModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeVendorsModal">&times;</span>
            <h2>Manage Vendors</h2>
            
            <div style="margin-bottom: 15px;">
                <button id="addVendorBtn" class="primary-btn">Add New Vendor</button>
            </div>
            
            <div class="vendor-container" id="vendorList">
                <!-- Vendor items will be added here -->
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button id="cancelVendorsBtn">Cancel</button>
                <button id="confirmVendorsBtn" class="primary-btn">Update Vendors</button>
            </div>
        </div>
    </div>
    
    <script>
        // Data structure
        let tableData = [];
        let vendorNames = [];
        let imageCache = {};
        let rowCounter = 1;
        
        // DOM elements
        const priceTable = document.getElementById('priceTable');
        const headerRow = document.getElementById('headerRow');
        const addRowBtn = document.getElementById('addRowBtn');
        const addAmountBtn = document.getElementById('addAmountBtn');
        const manageVendorsBtn = document.getElementById('manageVendorsBtn');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const saveDataBtn = document.getElementById('saveDataBtn');
        const printBtn = document.getElementById('printBtn');
        
        // Modal elements
        const addRowModal = document.getElementById('addRowModal');
        const closeAddRowModal = document.getElementById('closeAddRowModal');
        const cancelAddRowBtn = document.getElementById('cancelAddRowBtn');
        const confirmAddRowBtn = document.getElementById('confirmAddRowBtn');
        
        const addAmountModal = document.getElementById('addAmountModal');
        const closeAmountModal = document.getElementById('closeAmountModal');
        const cancelAmountBtn = document.getElementById('cancelAmountBtn');
        const confirmAmountBtn = document.getElementById('confirmAmountBtn');
        
        const manageVendorsModal = document.getElementById('manageVendorsModal');
        const closeVendorsModal = document.getElementById('closeVendorsModal');
        const cancelVendorsBtn = document.getElementById('cancelVendorsBtn');
        const confirmVendorsBtn = document.getElementById('confirmVendorsBtn');
        const addVendorBtn = document.getElementById('addVendorBtn');
        const vendorList = document.getElementById('vendorList');
        
        // Modal inputs
        const productInput = document.getElementById('productInput');
        const descriptionInput = document.getElementById('descriptionInput');
        const imageInput = document.getElementById('imageInput');
        const amountInput = document.getElementById('amountInput');
        const vendorInputs = document.getElementById('vendorInputs');
        
        const productSelect = document.getElementById('productSelect');
        const newAmountInput = document.getElementById('newAmountInput');
        const newVendorInputs = document.getElementById('newVendorInputs');
        
        // Event listeners
        addRowBtn.addEventListener('click', openAddRowModal);
        closeAddRowModal.addEventListener('click', closeModal);
        cancelAddRowBtn.addEventListener('click', closeModal);
        confirmAddRowBtn.addEventListener('click', addRow);
        
        addAmountBtn.addEventListener('click', openAddAmountModal);
        closeAmountModal.addEventListener('click', closeModal);
        cancelAmountBtn.addEventListener('click', closeModal);
        confirmAmountBtn.addEventListener('click', addAmountRow);
        
        manageVendorsBtn.addEventListener('click', openManageVendorsModal);
        closeVendorsModal.addEventListener('click', closeModal);
        cancelVendorsBtn.addEventListener('click', closeModal);
        confirmVendorsBtn.addEventListener('click', updateVendors);
        addVendorBtn.addEventListener('click', addVendor);
        
        exportCSVBtn.addEventListener('click', exportToCSV);
        saveDataBtn.addEventListener('click', saveData);
        printBtn.addEventListener('click', printTable);
        
        imageInput.addEventListener('change', previewImage);
        
        // Initialize from localStorage if available
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
        });
        
        // Functions
        function openAddRowModal() {
            addRowModal.style.display = 'block';
            // Clear previous inputs
            productInput.value = '';
            descriptionInput.value = '';
            imageInput.value = '';
            amountInput.value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            // Populate vendor input fields
            populateVendorInputs(vendorInputs);
        }
        
        function populateVendorInputs(container) {
            container.innerHTML = '';
            
            if (vendorNames.length === 0) {
                container.innerHTML = '<p>No vendors added yet. Please add vendors first.</p>';
                return;
            }
            
            vendorNames.forEach((vendor, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                
                const label = document.createElement('label');
                label.textContent = vendor + ':';
                label.style.display = 'block';
                label.style.marginBottom = '5px';
                div.appendChild(label);
                
                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('vendor-price-input');
                input.dataset.index = index;
                input.placeholder = '-';
                input.style.width = '100%';
                input.style.padding = '8px';
                input.style.boxSizing = 'border-box';
                div.appendChild(input);
                
                container.appendChild(div);
            });
        }
        
        function openAddAmountModal() {
            // Populate product dropdown
            populateProductDropdown();
            
            if (productSelect.options.length === 0) {
                alert('No products available. Please add a product first.');
                return;
            }
            
            addAmountModal.style.display = 'block';
            
            // Clear previous inputs
            newAmountInput.value = '';
            
            // Populate vendor input fields
            populateVendorInputs(newVendorInputs);
        }
        
        function populateProductDropdown() {
            productSelect.innerHTML = '';
            
            // Create a Set to track unique products
            const uniqueProducts = new Set();
            
            // Group rows by product and description
            tableData.forEach(row => {
                const key = `${row.product}|${row.description}`;
                uniqueProducts.add(key);
            });
            
            // Convert the Set to an array and create options
            Array.from(uniqueProducts).forEach(key => {
                const [product, description] = key.split('|');
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${product} - ${description}`;
                productSelect.appendChild(option);
            });
        }
        
        function openManageVendorsModal() {
            manageVendorsModal.style.display = 'block';
            
            // Populate current vendor list
            renderVendorList();
        }
        
        function renderVendorList() {
            vendorList.innerHTML = '';
            
            vendorNames.forEach((vendor, index) => {
                const vendorItem = document.createElement('div');
                vendorItem.className = 'vendor-item';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = vendor;
                input.dataset.index = index;
                input.className = 'vendor-name-input';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => removeVendor(index));
                
                vendorItem.appendChild(input);
                vendorItem.appendChild(removeBtn);
                vendorList.appendChild(vendorItem);
            });
            
            if (vendorNames.length === 0) {
                vendorList.innerHTML = '<p>No vendors added yet. Click "Add New Vendor" to add some.</p>';
            }
        }
        
        function addVendor() {
            const newVendorName = "Vendor " + (vendorNames.length + 1);
            
            const vendorItem = document.createElement('div');
            vendorItem.className = 'vendor-item';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = newVendorName;
            input.dataset.index = vendorNames.length;
            input.className = 'vendor-name-input';
            input.focus();
            input.select();
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', () => {
                vendorList.removeChild(vendorItem);
            });
            
            vendorItem.appendChild(input);
            vendorItem.appendChild(removeBtn);
            vendorList.appendChild(vendorItem);
            
            // Remove placeholder text if present
            const placeholder = vendorList.querySelector('p');
            if (placeholder) {
                vendorList.removeChild(placeholder);
            }
        }
        
        function removeVendor(index) {
            // We don't immediately remove from vendorNames array
            // This will be done when the user confirms the changes
            // Just remove from the DOM for now
            const vendorItems = vendorList.querySelectorAll('.vendor-item');
            if (index < vendorItems.length) {
                vendorList.removeChild(vendorItems[index]);
            }
            
            // Update data-index attributes for remaining vendors
            const remainingInputs = vendorList.querySelectorAll('.vendor-name-input');
            remainingInputs.forEach((input, i) => {
                input.dataset.index = i;
            });
        }
        
        function closeModal() {
            addRowModal.style.display = 'none';
            addAmountModal.style.display = 'none';
            manageVendorsModal.style.display = 'none';
        }
        
        function previewImage(event) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        }
        
        function formatProductText(text) {
            if (!text) return '';
            
            // Find and highlight in red: "White/Black"
            text = text.replace(/(White\/Black)/g, '<span class="highlight-red">$1</span>');
            
            // Process the text for newlines
            return text.split('\n').map(line => {
                // Check if this line contains dimensions (numbers followed by "cm")
                if (/\d+(\.\d+)?cm/.test(line)) {
                    // Process dimension lines
                    return line;
                } else {
                    // For non-dimension lines, check for specific highlights
                    if (line.includes('Child\'s Lock Lid')) {
                        return line;
                    } else {
                        return line;
                    }
                }
            }).join('<br>');
        }
        
        function addRow() {
            // Get values from inputs
            const product = productInput.value.trim();
            const description = descriptionInput.value.trim();
            const amount = amountInput.value.trim();
            
            // Validate required fields
            if (!product || !amount) {
                alert('Product and Amount are required fields');
                return;
            }
            
            // Get values from vendor inputs (or '-' if empty)
            const vendorInputEls = vendorInputs.querySelectorAll('.vendor-price-input');
            const vendorValues = Array.from(vendorInputEls).map(input => input.value.trim() || '-');
            
            // Get image if provided
            if (imageInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageId = `img_${Date.now()}`;
                    imageCache[imageId] = e.target.result;
                    
                    // Add row to data structure
                    const newRow = {
                        id: Date.now(),
                        no: rowCounter++,
                        image: imageId,
                        product: product,
                        description: description,
                        amount: amount,
                        vendorValues: vendorValues
                    };
                    
                    tableData.push(newRow);
                    renderTable();
                    closeModal();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                // Add row without image
                const newRow = {
                    id: Date.now(),
                    no: rowCounter++,
                    image: null,
                    product: product,
                    description: description,
                    amount: amount,
                    vendorValues: vendorValues
                };
                
                tableData.push(newRow);
                renderTable();
                closeModal();
            }
        }
        
        function addAmountRow() {
            if (productSelect.options.length === 0) {
                alert('No products available to add amount row');
                return;
            }
            
            const selectedOption = productSelect.value;
            const [product, description] = selectedOption.split('|');
            const newAmount = newAmountInput.value.trim();
            
            // Validate
            if (!newAmount) {
                alert('Amount is required');
                return;
            }
            
            // Get values from vendor inputs (or '-' if empty)
            const vendorInputEls = newVendorInputs.querySelectorAll('.vendor-price-input');
            const vendorValues = Array.from(vendorInputEls).map(input => input.value.trim() || '-');
            
            // Get the image from an existing row with the same product, if any
            let imageId = null;
            for (const row of tableData) {
                if (row.product === product && row.description === description && row.image) {
                    imageId = row.image;
                    break;
                }
            }
            
            // Add new row
            const newRow = {
                id: Date.now(),
                no: rowCounter++,
                image: imageId,
                product: product,
                description: description,
                amount: newAmount,
                vendorValues: vendorValues.length > 0 ? vendorValues : new Array(vendorNames.length).fill('-')
            };
            
            tableData.push(newRow);
            renderTable();
            closeModal();
        }
        
        function updateVendors() {
            // Get all vendor name inputs
            const vendorNameInputs = vendorList.querySelectorAll('.vendor-name-input');
            
            // Update vendor names array
            const newVendorNames = Array.from(vendorNameInputs).map(input => input.value.trim());
            
            // Check if the number of vendors has changed
            const oldVendorCount = vendorNames.length;
            const newVendorCount = newVendorNames.length;
            
            // Update vendor names
            vendorNames = newVendorNames;
            
            // Prepare old data for the new vendor structure
            if (oldVendorCount !== newVendorCount) {
                tableData.forEach(row => {
                    // Ensure each row has the right number of vendor values
                    if (row.vendorValues.length < newVendorCount) {
                        // Need to add more vendor columns
                        const diff = newVendorCount - row.vendorValues.length;
                        row.vendorValues = [...row.vendorValues, ...new Array(diff).fill('-')];
                    } else if (row.vendorValues.length > newVendorCount) {
                        // Need to remove vendor columns
                        row.vendorValues = row.vendorValues.slice(0, newVendorCount);
                    }
                });
            }
            
            // Update table headers
            updateVendorHeaders();
            
            // Re-render the table
            renderTable();
            
            closeModal();
        }
        
        function renderTable() {
            const tbody = priceTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            // Check if we need to render vendor headers
            updateVendorHeaders();
            
            if (tableData.length === 0) {
                return;
            }
            
            // Sort data by product, description, and amount
            const sortedData = [...tableData].sort((a, b) => {
                // First compare products
                if (a.product !== b.product) {
                    return a.product.localeCompare(b.product);
                }
                // Then compare descriptions
                if (a.description !== b.description) {
                    return a.description.localeCompare(b.description);
                }
                // Then compare amounts (numerically)
                const amountA = parseFloat(a.amount.replace(/,/g, ''));
                const amountB = parseFloat(b.amount.replace(/,/g, ''));
                return amountA - amountB;
            });
            
            // Group data by product and description
            const groups = {};
            sortedData.forEach(row => {
                const key = `${row.product}|${row.description}`;
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(row);
            });
            
            // Render each group
            Object.keys(groups).forEach(key => {
                const rows = groups[key];
                
                // Render each row in the group
                rows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // Only show product and description in the first row of the group
                    const isFirstInGroup = index === 0;
                    
                    // No. column
                    const tdNo = document.createElement('td');
                    tdNo.textContent = row.no;
                    tr.appendChild(tdNo);
                    
                    // Image column
                    const tdImage = document.createElement('td');
                    if (isFirstInGroup && row.image && imageCache[row.image]) {
                        const img = document.createElement('img');
                        img.src = imageCache[row.image];
                        img.style.maxWidth = '100px';
                        img.style.maxHeight = '100px';
                        tdImage.appendChild(img);
                    }
                    tr.appendChild(tdImage);
                    
                    // Product column
                    const tdProduct = document.createElement('td');
                    if (isFirstInGroup) {
                        tdProduct.innerHTML = formatProductText(row.product);
                    }
                    tr.appendChild(tdProduct);
                    
                    // Description column
                    const tdDescription = document.createElement('td');
                    if (isFirstInGroup) {
                        tdDescription.innerHTML = row.description;
                        
                        // Highlight "With" in red if description contains "With"
                        if (row.description.includes('With')) {
                            tdDescription.innerHTML = row.description.replace(/(With)/g, '<span class="highlight-red">$1</span>');
                        }
                    }
                    tr.appendChild(tdDescription);
                    
                    // Amount column
                    const tdAmount = document.createElement('td');
                    tdAmount.textContent = row.amount;
                    tr.appendChild(tdAmount);
                    
                    // Vendor value columns
                    row.vendorValues.forEach((value, i) => {
                        // Only create as many cells as we have vendor names
                        if (i < vendorNames.length) {
                            const tdVendor = document.createElement('td');
                            tdVendor.textContent = value;
                            tr.appendChild(tdVendor);
                        }
                    });
                    
                    tbody.appendChild(tr);
                });
            });
        }
        
        function updateVendorHeaders() {
            // Remove existing vendor headers
            const headerCells = headerRow.querySelectorAll('th');
            for (let i = headerCells.length - 1; i >= 5; i--) {
                headerRow.removeChild(headerCells[i]);
            }
            
            // Add current vendor headers
            vendorNames.forEach(vendor => {
                const th = document.createElement('th');
                th.textContent = vendor;
                th.className = 'vendor-col';
                headerRow.appendChild(th);
            });
        }
        
        function exportToCSV() {
            if (tableData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create header row
            let csvContent = `No.,Image,Product,Description,Amount,${vendorNames.join(',')}\n`;
            
            // Add data rows
            tableData.forEach(row => {
                // Prepare product text without HTML
                const cleanProduct = row.product.replace(/\n/g, ' ');
                
                // Create CSV row
                csvContent += `${row.no},"",${cleanProduct ? `"${cleanProduct}"` : ''},${row.description ? `"${row.description}"` : ''},${row.amount},${row.vendorValues.slice(0, vendorNames.length).join(',')}\n`;
            });
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'price_comparison.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function saveData() {
            try {
                // Prepare data to save
                const dataToSave = {
                    tableData: tableData,
                    vendorNames: vendorNames,
                    imageCache: imageCache,
                    rowCounter: rowCounter
                };
                
                // Save to localStorage
                localStorage.setItem('priceComparisonData', JSON.stringify(dataToSave));
                alert('Data saved successfully!');
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data: ' + error.message);
            }
        }
        
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('priceComparisonData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    tableData = parsedData.tableData || [];
                    vendorNames = parsedData.vendorNames || [];
                    imageCache = parsedData.imageCache || {};
                    rowCounter = parsedData.rowCounter || 1;
                    
                    // If no vendors have been set up, don't render the table yet
                    if (vendorNames.length > 0) {
                        // Render the table with the loaded data
                        renderTable();
                    } else {
                        // Prompt user to set up vendors
                        setTimeout(() => {
                            alert('Please set up your vendors first by clicking "Manage Vendors".');
                        }, 500);
                    }
                } else {
                    // No saved data, prompt user to set up vendors
                    setTimeout(() => {
                        alert('Welcome! Please set up your vendors first by clicking "Manage Vendors".');
                    }, 500);
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }
        
        function printTable() {
            window.print();
        }
    </script>
</body>
</html>
