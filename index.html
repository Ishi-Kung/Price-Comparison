<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass Jar Quote Comparison</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        h1, h2 {
            color: #2c3e50;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .data-input {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-controls {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .filter-group {
            display: inline-block;
            margin-right: 25px;
            margin-bottom: 10px;
        }
        
        label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        select, button, input[type="file"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
            padding: 8px 15px;
        }
        
        .primary-btn {
            background-color: #2ecc71;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .primary-btn:hover {
            background-color: #27ae60;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            cursor: pointer;
            position: relative;
        }
        
        th:hover {
            background-color: #2980b9;
        }
        
        th::after {
            content: "↕";
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }
        
        th.asc::after {
            content: "↑";
            opacity: 1;
        }
        
        th.desc::after {
            content: "↓";
            opacity: 1;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .highlight {
            background-color: #e5f7fd;
        }
        
        .best-value {
            background-color: #e8f8f5;
            border-left: 4px solid #27ae60;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            border-radius: 0;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: #333;
            margin: 0;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #3498db;
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: white;
        }
        
        .helper-text {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .sample-data {
            font-size: 0.8em;
            color: #7f8c8d;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9em;
            color: #7f8c8d;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 768px) {
            .filter-group {
                display: block;
                margin-bottom: 15px;
            }
            
            .tab button {
                float: none;
                display: block;
                width: 100%;
                text-align: left;
            }
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <h1>Glass Jar Quote Comparison</h1>
    
    <div class="section">
        <h2>Load Your Quote Data</h2>
        <p>Choose how to load your glass jar quotes:</p>
        
        <div class="tab-container">
            <div class="tab">
                <button class="tablinks active" onclick="openTab(event, 'file-upload')">Upload CSV File</button>
                <button class="tablinks" onclick="openTab(event, 'manual-entry')">Enter Data Manually</button>
                <button class="tablinks" onclick="openTab(event, 'paste-data')">Paste Data</button>
            </div>
            
            <div id="file-upload" class="tabcontent" style="display: block;">
                <p>Upload a CSV file with your jar quotes:</p>
                <input type="file" id="csv-file" accept=".csv">
                <p class="helper-text">Your CSV should include columns for: Has Sticker, Size (oz), Price, MOQ (Minimum Order Quantity), and Supplier</p>
                <a href="#" class="sample-data" onclick="downloadSampleCSV()">Download Sample CSV Template</a>
                <div class="button-container" style="margin-top: 15px;">
                    <button onclick="loadCSV()" class="primary-btn">Load Data from CSV</button>
                </div>
            </div>
            
            <div id="manual-entry" class="tabcontent">
                <p>Enter your quote data into the table below:</p>
                <div class="table-container">
                    <table id="data-entry-table">
                        <thead>
                            <tr>
                                <th>Has Sticker</th>
                                <th>Size (oz)</th>
                                <th>Price ($)</th>
                                <th>MOQ</th>
                                <th>Supplier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="checkbox" class="has-sticker"></td>
                                <td><input type="number" step="0.1" class="jar-size" placeholder="e.g. 8"></td>
                                <td><input type="number" step="0.01" class="price" placeholder="e.g. 1.10"></td>
                                <td><input type="number" class="moq" placeholder="e.g. 1000"></td>
                                <td><input type="text" class="supplier" placeholder="e.g. Supplier A"></td>
                                <td><button onclick="removeRow(this)">Remove</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="button-container" style="margin-top: 15px;">
                    <button onclick="addRow()">Add Row</button>
                    <button onclick="loadManualData()" class="primary-btn">Load Data</button>
                </div>
                <a href="#" class="sample-data" onclick="loadSampleData()">Load Sample Data</a>
            </div>
            
            <div id="paste-data" class="tabcontent">
                <p>Paste your data in CSV or JSON format:</p>
                <textarea id="paste-area" placeholder="Paste your data here in CSV format (with headers) or JSON format"></textarea>
                <div class="button-container">
                    <button onclick="detectAndLoadPastedData()" class="primary-btn">Parse and Load Data</button>
                </div>
                <p class="helper-text">CSV Format Example: Has Sticker,Size,Price,MOQ,Supplier<br>Yes,8,1.10,1000,Supplier A</p>
                <a href="#" class="sample-data" onclick="loadSamplePasteData()">Load Sample Data Format</a>
            </div>
        </div>
    </div>
    
    <div id="comparison-section" class="hidden">
        <div class="filter-controls">
            <div class="filter-group">
                <label>Sticker:</label>
                <label class="checkbox-label">
                    <input type="checkbox" id="with-sticker" checked> With
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="without-sticker" checked> Without
                </label>
            </div>
            
            <div class="filter-group">
                <label for="jar-size">Size:</label>
                <select id="jar-size">
                    <option value="all">All Sizes</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="supplier">Supplier:</label>
                <select id="supplier">
                    <option value="all">All Suppliers</option>
                </select>
            </div>
            
            <button id="highlight-best-value">Highlight Best Value</button>
            <button id="reset-filters">Reset Filters</button>
        </div>
        
        <div class="section">
            <h2>Quote Comparison Table</h2>
            <div class="table-container">
                <table id="jar-table">
                    <thead>
                        <tr>
                            <th data-sort="has-sticker">Has Sticker</th>
                            <th data-sort="size">Size (oz)</th>
                            <th data-sort="price">Price ($)</th>
                            <th data-sort="moq">MOQ</th>
                            <th data-sort="supplier">Supplier</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="export-section">
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="printTable()">Print Table</button>
                <button onclick="saveDataLocally()">Save Data for Later</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Cost Analysis</h2>
            <div id="cost-analysis">
                <!-- Analysis will be generated here -->
            </div>
        </div>
    </div>
    
    <footer>
        <p>Glass Jar Quote Comparison Tool - For internal use only</p>
        <p>Data is stored locally in your browser and is not sent to any server</p>
    </footer>

    <script>
        // Data storage
        let jarData = [];
        
        // Tab functionality
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // CSV File handling
        function loadCSV() {
            const fileInput = document.getElementById('csv-file');
            if (!fileInput.files.length) {
                alert('Please select a CSV file to upload.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    jarData = parseCSV(content);
                    renderTable();
                    showComparisonSection();
                } catch (error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',').map(header => header.trim());
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const row = {};
                
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j] ? values[j].trim() : '';
                    
                    const key = headers[j].replace(/ /g, '').toLowerCase();
                    
                    // Handle special cases
                    if (key === 'hassticker') {
                        row[key] = value.toLowerCase() === 'yes' || value === '1' || value.toLowerCase() === 'true';
                    }
                    else if (['size', 'price', 'moq'].includes(key)) {
                        row[key] = parseFloat(value) || 0;
                    }
                    else {
                        row[key] = value;
                    }
                }
                
                result.push(row);
            }
            
            return result;
        }
        
        // Manual data entry
        function addRow() {
            const tbody = document.querySelector('#data-entry-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="checkbox" class="has-sticker"></td>
                <td><input type="number" step="0.1" class="jar-size" placeholder="e.g. 8"></td>
                <td><input type="number" step="0.01" class="price" placeholder="e.g. 1.10"></td>
                <td><input type="number" class="moq" placeholder="e.g. 1000"></td>
                <td><input type="text" class="supplier" placeholder="e.g. Supplier A"></td>
                <td><button onclick="removeRow(this)">Remove</button></td>
            `;
            tbody.appendChild(newRow);
        }
        
        function removeRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
        
        function loadManualData() {
            const rows = document.querySelectorAll('#data-entry-table tbody tr');
            jarData = [];
            
            rows.forEach(row => {
                const hasSticker = row.querySelector('.has-sticker').checked;
                const size = parseFloat(row.querySelector('.jar-size').value);
                const price = parseFloat(row.querySelector('.price').value);
                const moq = parseFloat(row.querySelector('.moq').value);
                const supplier = row.querySelector('.supplier').value.trim();
                
                if (!isNaN(size) && !isNaN(price)) {
                    jarData.push({
                        hassticker: hasSticker,
                        size: size,
                        price: price,
                        moq: moq || 0,
                        supplier: supplier
                    });
                }
            });
            
            if (jarData.length === 0) {
                alert('Please enter at least one valid row of data.');
                return;
            }
            
            renderTable();
            showComparisonSection();
        }
        
        function loadSampleData() {
            document.querySelector('#data-entry-table tbody').innerHTML = '';
            
            const sampleData = [
                {hassticker: true, size: 4, price: 0.85, moq: 1000, supplier: 'Supplier A'},
                {hassticker: false, size: 4, price: 0.70, moq: 1000, supplier: 'Supplier A'},
                {hassticker: true, size: 8, price: 1.10, moq: 1500, supplier: 'Supplier A'},
                {hassticker: false, size: 8, price: 0.95, moq: 1500, supplier: 'Supplier A'},
                {hassticker: true, size: 16, price: 1.45, moq: 2000, supplier: 'Supplier A'},
                {hassticker: false, size: 16, price: 1.30, moq: 2000, supplier: 'Supplier A'},
                {hassticker: true, size: 4, price: 0.82, moq: 2000, supplier: 'Supplier B'},
                {hassticker: false, size: 4, price: 0.66, moq: 2000, supplier: 'Supplier B'},
                {hassticker: true, size: 8, price: 1.05, moq: 1000, supplier: 'Supplier B'},
                {hassticker: false, size: 8, price: 0.90, moq: 1000, supplier: 'Supplier B'}
            ];
            
            sampleData.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="checkbox" class="has-sticker" ${item.hassticker ? 'checked' : ''}></td>
                    <td><input type="number" step="0.1" class="jar-size" value="${item.size}"></td>
                    <td><input type="number" step="0.01" class="price" value="${item.price}"></td>
                    <td><input type="number" class="moq" value="${item.moq}"></td>
                    <td><input type="text" class="supplier" value="${item.supplier}"></td>
                    <td><button onclick="removeRow(this)">Remove</button></td>
                `;
                document.querySelector('#data-entry-table tbody').appendChild(newRow);
            });
        }
        
        // Paste data handling
        function detectAndLoadPastedData() {
            const pasteContent = document.getElementById('paste-area').value.trim();
            if (!pasteContent) {
                alert('Please paste data before loading.');
                return;
            }
            
            try {
                // Try to parse as JSON first
                if (pasteContent.startsWith('[') || pasteContent.startsWith('{')) {
                    jarData = JSON.parse(pasteContent);
                    
                    // Handle object structure differences
                    jarData = jarData.map(item => {
                        const normalized = {};
                        
                        // Map various possible key names to our standard keys
                        for (const [key, value] of Object.entries(item)) {
                            const lowerKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                            
                            if (lowerKey.includes('sticker')) {
                                if (typeof value === 'boolean') {
                                    normalized.hassticker = value;
                                } else {
                                    normalized.hassticker = value === 'Yes' || value === '1' || value === 'true' || value === true;
                                }
                            }
                            else if (lowerKey.includes('size')) normalized.size = parseFloat(value);
                            else if (lowerKey.includes('price')) normalized.price = parseFloat(value);
                            else if (lowerKey.includes('moq') || lowerKey.includes('minimum')) normalized.moq = parseFloat(value);
                            else if (lowerKey.includes('supplier') || lowerKey.includes('vendor')) normalized.supplier = value;
                            else normalized[lowerKey] = value; // Keep other fields
                        }
                        
                        return normalized;
                    });
                } else {
                    // Parse as CSV
                    jarData = parseCSV(pasteContent);
                }
                
                renderTable();
                showComparisonSection();
            } catch (error) {
                alert('Error parsing data: ' + error.message + '. Please check the format and try again.');
            }
        }
        
        function loadSamplePasteData() {
            document.getElementById('paste-area').value = 
`Has Sticker,Size,Price,MOQ,Supplier
Yes,4,0.85,1000,Supplier A
No,4,0.70,1000,Supplier A
Yes,8,1.10,1500,Supplier A
No,8,0.95,1500,Supplier A
Yes,16,1.45,2000,Supplier A
No,16,1.30,2000,Supplier A
Yes,4,0.82,2000,Supplier B
No,4,0.66,2000,Supplier B
Yes,8,1.05,1000,Supplier B
No,8,0.90,1000,Supplier B`;
        }
        
        // Sample CSV download
        function downloadSampleCSV() {
            const csvContent = 
`Has Sticker,Size,Price,MOQ,Supplier
Yes,4,0.85,1000,Supplier A
No,4,0.70,1000,Supplier A
Yes,8,1.10,1500,Supplier A
No,8,0.95,1500,Supplier A
Yes,16,1.45,2000,Supplier A
No,16,1.30,2000,Supplier A
Yes,4,0.82,2000,Supplier B
No,4,0.66,2000,Supplier B
Yes,8,1.05,1000,Supplier B
No,8,0.90,1000,Supplier B`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'sample_jar_quotes.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Display functionality
        function showComparisonSection() {
            document.getElementById('comparison-section').classList.remove('hidden');
            document.querySelector('.filter-controls').style.display = 'block';
            populateFilterOptions();
            generateAnalysis();
            
            // Add event listeners for filtering and sorting
            document.getElementById('with-sticker').addEventListener('change', filterTable);
            document.getElementById('without-sticker').addEventListener('change', filterTable);
            document.getElementById('jar-size').addEventListener('change', filterTable);
            document.getElementById('supplier').addEventListener('change', filterTable);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            document.getElementById('highlight-best-value').addEventListener('click', highlightBestValues);
            
            const headers = document.querySelectorAll('#jar-table th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    sortTable(this.dataset.sort);
                });
            });
            
            // Scroll to the comparison section
            document.getElementById('comparison-section').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        function renderTable() {
            const tbody = document.querySelector('#jar-table tbody');
            tbody.innerHTML = '';
            
            jarData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.hassticker ? 'Yes' : 'No'}</td>
                    <td>${item.size || 0}</td>
                    <td>$${(item.price || 0).toFixed(2)}</td>
                    <td>${item.moq || 0}</td>
                    <td>${item.supplier || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateFilterOptions() {
            const sizes = new Set();
            const suppliers = new Set();
            
            jarData.forEach(item => {
                if (item.size) sizes.add(item.size);
                if (item.supplier) suppliers.add(item.supplier);
            });
            
            const jarSizeSelect = document.getElementById('jar-size');
            const supplierSelect = document.getElementById('supplier');
            
            // Clear existing options except the first one
            jarSizeSelect.innerHTML = '<option value="all">All Sizes</option>';
            supplierSelect.innerHTML = '<option value="all">All Suppliers</option>';
            
            // Add new options
            Array.from(sizes).sort((a, b) => a - b).forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = `${size} oz`;
                jarSizeSelect.appendChild(option);
            });
            
            Array.from(suppliers).sort().forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });
        }
        
        // Filtering and sorting
        function filterTable() {
            const withSticker = document.getElementById('with-sticker').checked;
            const withoutSticker = document.getElementById('without-sticker').checked;
            const jarSize = parseFloat(document.getElementById('jar-size').value);
            const supplier = document.getElementById('supplier').value;
            
            const rows = document.querySelectorAll('#jar-table tbody tr');
            
            rows.forEach(row => {
                const hasSticker = row.cells[0].textContent === 'Yes';
                const rowSize = parseFloat(row.cells[1].textContent);
                const rowSupplier = row.cells[4].textContent;
                
                const stickerMatch = (hasSticker && withSticker) || (!hasSticker && withoutSticker);
                const sizeMatch = isNaN(jarSize) || rowSize === jarSize;
                const supplierMatch = supplier === 'all' || rowSupplier === supplier;
                
                if (stickerMatch && sizeMatch && supplierMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function resetFilters() {
            document.getElementById('with-sticker').checked = true;
            document.getElementById('without-sticker').checked = true;
            document.getElementById('jar-size').value = 'all';
            document.getElementById('supplier').value = 'all';
            
            const rows = document.querySelectorAll('#jar-table tbody tr');
            rows.forEach(row => {
                row.style.display = '';
                row.classList.remove('highlight', 'best-value');
            });
        }
        
        function sortTable(sortBy) {
            const header = document.querySelector(`th[data-sort="${sortBy}"]`);
            const isAsc = header.classList.contains('asc');
            
            // Reset all headers
            document.querySelectorAll('th[data-sort]').forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            
            // Set new sort direction
            header.classList.add(isAsc ? 'desc' : 'asc');
            
            const tbody = document.querySelector('#jar-table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Map sortBy to column index
            const columnMap = {
                'has-sticker': 0,
                'size': 1,
                'price': 2,
                'moq': 3,
                'supplier': 4
            };
            
            const columnIndex = columnMap[sortBy];
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent;
                let bVal = b.cells[columnIndex].textContent;
                
                // Handle Yes/No for sticker
                if (columnIndex === 0) {
                    aVal = aVal === 'Yes' ? 1 : 0;
                    bVal = bVal === 'Yes' ? 1 : 0;
                    return isAsc ? bVal - aVal : aVal - bVal;
                }
                // Convert to numbers for numeric columns
                else if ([1, 2, 3].includes(columnIndex)) {
                    // Remove $ sign if present
                    if (aVal.includes('$')) aVal = aVal.replace('$', '');
                    if (bVal.includes('$')) bVal = bVal.replace('$', '');
                    
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                    return isAsc ? bVal - aVal : aVal - bVal;
                } 
                // Sort text for supplier
                else {
                    return isAsc ? 
                        bVal.localeCompare(aVal) : 
                        aVal.localeCompare(bVal);
                }
            });
            
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function highlightBestValues() {
            // Remove existing highlights
            document.querySelectorAll('#jar-table tbody tr').forEach(row => {
                row.classList.remove('best-value');
            });
            
            // Get visible rows
            const visibleRows = Array.from(document.querySelectorAll('#jar-table tbody tr'))
                .filter(row => row.style.display !== 'none');
            
            // Group by size and sticker option
            const groups = {};
            visibleRows.forEach(row => {
                const hasSticker = row.cells[0].textContent === 'Yes';
                const size = row.cells[1].textContent;
                const price = parseFloat(row.cells[2].textContent.replace('$', ''));
                
                const key = `${size}_${hasSticker ? 'sticker' : 'nosticker'}`;
                
                if (!groups[key] || price < groups[key].price) {
                    groups[key] = { row, price };
                }
            });
            
            // Highlight best values
            Object.values(groups).forEach(item => {
                item.row.classList.add('best-value');
            });
        }
        
        // Analysis generation
        function generateAnalysis() {
            const analysisDiv = document.getElementById('cost-analysis');
            
            // Find lowest price for each size and sticker combination
            const bestPrices = {};
            
            jarData.forEach(item => {
                const key = `${item.size}_${item.hassticker ? 'sticker' : 'nosticker'}`;
                if (!bestPrices[key] || item.price < bestPrices[key].price) {
                    bestPrices[key] = { 
                        price: item.price, 
                        supplier: item.supplier,
                        moq: item.moq
                    };
                }
            });
            
            // Calculate sticker price difference
            const stickerCostDiff = {};
            
            Object.keys(bestPrices).forEach(key => {
                const [size, type] = key.split('_');
                if (type === 'sticker') {
                    const noStickerKey = `${size}_nosticker`;
                    if (bestPrices[noStickerKey]) {
                        stickerCostDiff[size] = bestPrices[key].price - bestPrices[noStickerKey].price;
                    }
                }
            });
            
            // Calculate MOQ impact
            const moqImpact = {};
            const sizes = new Set();
            
            jarData.forEach(item => {
                sizes.add(item.size);
                
                const key = `${item.size}_${item.supplier}`;
                if (!moqImpact[key] || item.moq > moqImpact[key].moq) {
                    moqImpact[key] = {
                        size: item.size,
                        supplier: item.supplier,
                        moq: item.moq
                    };
                }
            });
            
            // Build analysis HTML
            let analysisHTML = `
                <h3>Price Analysis Summary</h3>
                
                <h4>Best Prices by Size:</h4>
                <ul>
            `;
            
            // Sort sizes for display
            const sortedSizes = Array.from(sizes).sort((a, b) => a - b);
            
            sortedSizes.forEach(size => {
                const withStickerKey = `${size}_sticker`;
                const noStickerKey = `${size}_nosticker`;
                
                if (bestPrices[withStickerKey]) {
                    analysisHTML += `<li><strong>${size} oz with sticker:</strong> $${bestPrices[withStickerKey].price.toFixed(2)} from ${bestPrices[withStickerKey].supplier} (MOQ: ${bestPrices[withStickerKey].moq})</li>`;
                }
                
                if (bestPrices[noStickerKey]) {
                    analysisHTML += `<li><strong>${size} oz without sticker:</strong> $${bestPrices[noStickerKey].price.toFixed(2)} from ${bestPrices[noStickerKey].supplier} (MOQ: ${bestPrices[noStickerKey].moq})</li>`;
                }
            });
            
            analysisHTML += `
                </ul>
                
                <h4>Sticker Cost Analysis:</h4>
                <ul>
            `;
            
            // Display sticker cost differences
            sortedSizes.forEach(size => {
                if (stickerCostDiff[size]) {
                    const percentage = (stickerCostDiff[size] / bestPrices[`${size}_nosticker`].price * 100).toFixed(1);
                    analysisHTML += `<li><strong>${size} oz jars:</strong> Adding stickers costs $${stickerCostDiff[size].toFixed(2)} more per jar (${percentage}% increase)</li>`;
                }
            });
            
            analysisHTML += `
                </ul>
                
                <h4>MOQ Considerations:</h4>
                <ul>
            `;
            
            // Display MOQ information
            const supplierMOQs = {};
            
            Object.values(moqImpact).forEach(item => {
                if (!supplierMOQs[item.supplier]) {
                    supplierMOQs[item.supplier] = [];
                }
                supplierMOQs[item.supplier].push(item);
            });
            
            Object.entries(supplierMOQs).forEach(([supplier, items]) => {
                // Find highest MOQ for this supplier
                const highestMOQ = Math.max(...items.map(item => item.moq));
                const sizesWithHighestMOQ = items.filter(item => item.moq === highestMOQ).map(item => `${item.size} oz`).join(', ');
                
                analysisHTML += `<li><strong>${supplier}:</strong> Highest MOQ is ${highestMOQ} units for ${sizesWithHighestMOQ} jars</li>`;
            });
            
            analysisHTML += `
                </ul>
                
                <h4>Final Recommendations:</h4>
                <p>Based on your quotes, here are the best options to consider:</p>
                <ul>
            `;
            
            // Generate recommendations based on best value
            let bestOverallSupplier = findBestOverallSupplier();
            let lowestMOQSupplier = findLowestMOQSupplier();
            
            if (bestOverallSupplier) {
                analysisHTML += `<li><strong>Best overall pricing:</strong> ${bestOverallSupplier} offers the most competitive pricing across sizes</li>`;
            }
            
            if (lowestMOQSupplier) {
                analysisHTML += `<li><strong>Lowest minimum order:</strong> ${lowestMOQSupplier} has the lowest MOQ requirements</li>`;
            }
            
            // Add size-specific recommendations
            sortedSizes.forEach(size => {
                const withStickerKey = `${size}_sticker`;
                const noStickerKey = `${size}_nosticker`;
                
                if (bestPrices[withStickerKey] && bestPrices[noStickerKey]) {
                    // If the same supplier is best for both with and without sticker
                    if (bestPrices[withStickerKey].supplier === bestPrices[noStickerKey].supplier) {
                        analysisHTML += `<li><strong>${size} oz jars:</strong> ${bestPrices[withStickerKey].supplier} offers best pricing for both sticker and non-sticker options</li>`;
                    }
                }
            });
            
            analysisHTML += `
                </ul>
            `;
            
            analysisDiv.innerHTML = analysisHTML;
        }
        
        function findBestOverallSupplier() {
            const supplierPoints = {};
            
            // Group data by size and sticker option
            const groups = {};
            jarData.forEach(item => {
                const key = `${item.size}_${item.hassticker ? 'sticker' : 'nosticker'}`;
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(item);
            });
            
            // For each group, give points to the supplier with the best price
            Object.values(groups).forEach(items => {
                items.sort((a, b) => a.price - b.price);
                const bestItem = items[0];
                
                if (!supplierPoints[bestItem.supplier]) {
                    supplierPoints[bestItem.supplier] = 0;
                }
                supplierPoints[bestItem.supplier] += 1;
            });
            
            // Find supplier with most points
            let bestSupplier = null;
            let maxPoints = 0;
            
            Object.entries(supplierPoints).forEach(([supplier, points]) => {
                if (points > maxPoints) {
                    maxPoints = points;
                    bestSupplier = supplier;
                }
            });
            
            return bestSupplier;
        }
        
        function findLowestMOQSupplier() {
            const supplierMinMOQs = {};
            
            // Find minimum MOQ for each supplier
            jarData.forEach(item => {
                if (!supplierMinMOQs[item.supplier] || item.moq < supplierMinMOQs[item.supplier]) {
                    supplierMinMOQs[item.supplier] = item.moq;
                }
            });
            
            // Find supplier with lowest minimum MOQ
            let lowestMOQSupplier = null;
            let lowestMOQ = Infinity;
            
            Object.entries(supplierMinMOQs).forEach(([supplier, moq]) => {
                if (moq < lowestMOQ) {
                    lowestMOQ = moq;
                    lowestMOQSupplier = supplier;
                }
            });
            
            return lowestMOQSupplier;
        }
        
        // Export and save functionality
        function exportToCSV() {
            // Create CSV content
            let csvContent = 'Has Sticker,Size,Price,MOQ,Supplier\n';
            
            jarData.forEach(item => {
                csvContent += `${item.hassticker ? 'Yes' : 'No'},${item.size || 0},${item.price || 0},${item.moq || 0},${item.supplier || ''}\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute('href', url);
            link.setAttribute('download', `jar_quotes_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function printTable() {
            window.print();
        }
        
        function saveDataLocally() {
            try {
                localStorage.setItem('jarQuoteData', JSON.stringify(jarData));
                alert('Data saved successfully! It will be available next time you open this page.');
            } catch (error) {
                alert('Error saving data: ' + error.message);
            }
        }
        
        // Check for saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const savedData = localStorage.getItem('jarQuoteData');
                if (savedData) {
                    const shouldLoad = confirm('Found previously saved quote data. Would you like to load it?');
                    if (shouldLoad) {
                        jarData = JSON.parse(savedData);
                        renderTable();
                        showComparisonSection();
                    }
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        });
    </script>
</body>
</html>
